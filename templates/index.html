<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Summarizer</title>
    <style>
        :root{--primary:#4361ee;--secondary:#3f37c9;--accent:#4cc9f0;--light:#f8f9fa;--dark:#212529;--success:#4ade80;--warning:#facc15;--danger:#f87171;--card-shadow:0 4px 20px rgba(0,0,0,.08);--transition:all .3s ease}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:var(--dark);background:linear-gradient(135deg,#f5f7fa 0%,#e4edf5 100%);min-height:100vh;padding:20px}.container{max-width:1200px;margin:0 auto}header{text-align:center;padding:30px 0;margin-bottom:20px}h1{font-size:2.5rem;margin-bottom:10px;color:var(--primary);display:flex;align-items:center;justify-content:center;gap:12px}.subtitle{font-size:1.1rem;color:#6c757d;margin-bottom:25px}.search-section{background:white;border-radius:12px;padding:25px;box-shadow:var(--card-shadow);margin-bottom:30px}.search-form{display:flex;gap:10px;margin-bottom:20px}.search-input{flex-grow:1;padding:15px 20px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;transition:var(--transition)}.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(76,201,240,.2)}.search-button{padding:15px 25px;border:none;background:var(--primary);color:white;font-size:1rem;font-weight:600;border-radius:8px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.search-button:hover{background:var(--secondary);transform:translateY(-2px)}.filters{display:flex;flex-wrap:wrap;gap:12px;margin-top:15px}.filter-btn{padding:8px 16px;background:#edf2f7;border:none;border-radius:20px;font-size:.9rem;cursor:pointer;transition:var(--transition)}.filter-btn:hover,.filter-btn.active{background:var(--primary);color:white}.news-feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px;margin-bottom:40px}
        
        .article-card{background:white;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:var(--transition);display:flex;flex-direction:column;height:100%}
        .article-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
        
        /* --- NEW: Image Styles --- */
        .card-image-container { height: 180px; overflow: hidden; }
        .card-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .article-card:hover .card-image { transform: scale(1.05); }

        .card-content{padding:20px;flex-grow:1;display:flex;flex-direction:column}
        .summary-container{background:#f0f9ff;border-left:4px solid var(--accent);padding:15px;border-radius:8px;transition:var(--transition)}
        .summary-container.processing{background:#f8fafc;border-left-color:#cbd5e1}
        .summary-container.error{background:#fff1f2;border-left-color:var(--danger)}
        .summary-title{font-weight:600;color:var(--primary);display:flex;align-items:center;gap:8px;margin-bottom:8px}
        .summary-text{font-size:.95rem;color:#4a5568}
        .summary-container.error .summary-text{color:var(--danger)}
        .card-footer{margin-top:auto;padding-top:15px;border-top:1px solid #e2e8f0}
        .card-title{font-size:1.1rem;margin-bottom:8px;line-height:1.4}
        .card-title a{color:var(--dark);text-decoration:none;transition:var(--transition)}
        .card-title a:hover{color:var(--primary)}
        .card-meta{display:flex;justify-content:space-between;color:#6c757d;font-size:.85rem}
        
        /* --- Unchanged Styles --- */
        .loader{text-align:center;padding:40px;grid-column:1/-1;display:none}.loader-spinner{border:4px solid rgba(67,97,238,.2);border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.load-more-container{text-align:center;margin:30px 0}#load-more-btn{background:var(--primary);color:white;border:none;padding:14px 30px;font-size:1rem;font-weight:600;border-radius:8px;cursor:pointer;transition:var(--transition);display:none;align-items:center;gap:10px}#load-more-btn:hover{background:var(--secondary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(67,97,238,.25)}#no-more-results{display:none;color:#6c757d;font-style:italic;padding:20px}footer{text-align:center;padding:30px 0;color:#6c757d;font-size:.9rem;border-top:1px solid #e2e8f0;margin-top:20px}.model-info{background:#e0f2fe;padding:12px 20px;border-radius:8px;display:inline-block;margin:15px 0;font-size:.95rem}@media (max-width:768px){.news-feed{grid-template-columns:1fr}.search-form{flex-direction:column}h1{font-size:2rem}}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header, Search, Filters... (all unchanged) -->
        <header>
            <h1><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg> AI News Summarizer</h1>
            <p class="subtitle">Get the latest news with AI-powered summaries, fast.</p>
        </header>
        <section class="search-section">
            <form id="search-form" class="search-form">
                <input type="search" id="search-input" class="search-input" placeholder="Search for news or leave blank for trending...">
                <button type="submit" class="search-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> <span>Search</span></button>
            </form>
            <div class="filters">
                {% for topic in filter_topics %}
                    <button class="filter-btn" data-query="{{ topic }}">{{ topic }}</button>
                {% endfor %}
            </div>
        </section>
        <div class="model-info">ðŸ’¡ Summaries by <strong>{{ model_name }}</strong></div>
        <div id="news-feed" class="news-feed"></div>
        <div id="loader" class="loader"><div class="loader-spinner"></div><p>Fetching news...</p></div>
        <div id="load-more-container">
            <button id="load-more-btn"><span>Load More</span> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 15 11"></polyline><path d="M12 3v11"></path></svg></button>
            <p id="no-more-results">-- End of Results --</p>
        </div>
    </div>
    <footer><p>News provided by Google News RSS. App by Gemini.</p></footer>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // JavaScript state and functions (all unchanged)
            const newsFeed = document.getElementById('news-feed');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const loader = document.getElementById('loader');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const noMoreResultsMsg = document.getElementById('no-more-results');
            let currentPage = 1;
            let currentQuery = '';
            let isLoading = false;
            let statusUpdaterInterval = null;

            const fetchNews = async (isLoadMore = false) => {
                if (isLoading) return;
                isLoading = true;
                if (!isLoadMore) {
                    newsFeed.innerHTML = '';
                    loader.style.display = 'grid';
                }
                loadMoreBtn.style.display = 'none';
                try {
                    const response = await fetch(`/get-news?q=${encodeURIComponent(currentQuery)}&page=${currentPage}`);
                    const data = await response.json();
                    if (data.articles && data.articles.length > 0) {
                        data.articles.forEach(article => {
                            newsFeed.insertAdjacentHTML('beforeend', createArticleCard(article));
                        });
                    } else if (currentPage === 1) {
                        newsFeed.innerHTML = `<p>No articles found for '${currentQuery}'. Please try another search.</p>`;
                    }
                    if (data.has_more) {
                        loadMoreBtn.style.display = 'inline-flex';
                    } else if (newsFeed.children.length > 0) {
                        noMoreResultsMsg.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Failed to fetch news:", error);
                    newsFeed.innerHTML = `<p>An error occurred while fetching news. Please check the console and try again.</p>`;
                } finally {
                    isLoading = false;
                    loader.style.display = 'none';
                }
            };
            const startNewSearch = (query) => {
                currentQuery = query.trim();
                currentPage = 1;
                noMoreResultsMsg.style.display = 'none';
                document.querySelectorAll('.filter-btn.active').forEach(btn => btn.classList.remove('active'));
                const newActiveBtn = document.querySelector(`.filter-btn[data-query="${currentQuery}"]`);
                if (newActiveBtn) newActiveBtn.classList.add('active');
                if (statusUpdaterInterval) clearInterval(statusUpdaterInterval);
                fetchNews().then(() => {
                    statusUpdaterInterval = setInterval(updateStatuses, 7000);
                });
            };
            const updateStatuses = async () => {
                const pagesToUpdate = currentPage;
                for (let i = 1; i <= pagesToUpdate; i++) {
                    const response = await fetch(`/get-news?q=${encodeURIComponent(currentQuery)}&page=${i}`);
                    const data = await response.json();
                    if (!data.articles) continue;
                    data.articles.forEach(article => {
                        const card = document.querySelector(`[data-link="${article.link}"]`);
                        if (card && card.dataset.status !== article.status) {
                            const summaryContainer = card.querySelector('.summary-container');
                            updateSummaryContainer(summaryContainer, article);
                            card.dataset.status = article.status;
                        }
                    });
                }
            };
            const updateSummaryContainer = (container, article) => {
                let summaryHtml;
                container.className = 'summary-container';
                switch(article.status) {
                    case 'in_progress': summaryHtml = 'Summarizing now...'; container.classList.add('processing'); break;
                    case 'done': summaryHtml = article.ai_summary; break;
                    case 'error': summaryHtml = article.ai_summary || 'An unknown error occurred.'; container.classList.add('error'); break;
                    default: summaryHtml = 'Queued for summary...'; container.classList.add('processing'); break;
                }
                container.querySelector('.summary-text').innerHTML = summaryHtml;
            };

            const createArticleCard = (article) => {
                let summaryHtml;
                let containerClass = 'summary-container';
                switch(article.status) {
                    case 'in_progress': summaryHtml = 'Summarizing now...'; containerClass += ' processing'; break;
                    case 'done': summaryHtml = article.ai_summary; break;
                    case 'error': summaryHtml = article.ai_summary || 'An unknown error occurred.'; containerClass += ' error'; break;
                    default: summaryHtml = 'Queued for summary...'; containerClass += ' processing'; break;
                }

                // --- NEW: Conditionally create the image HTML ---
                const imageHtml = article.image_url
                    ? `<div class="card-image-container"><img src="${article.image_url}" alt="Article image for ${article.title}" class="card-image" loading="lazy"></div>`
                    : '';

                return `
                    <div class="article-card" data-link="${article.link}" data-status="${article.status}">
                        ${imageHtml}
                        <div class="card-content">
                            <div class="${containerClass}">
                                <div class="summary-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M12 12h4"/><path d="M12 16h4"/><path d="M8 12h.01"/><path d="M8 16h.01"/></svg>
                                    <span>AI Summary</span>
                                </div>
                                <p class="summary-text">${summaryHtml}</p>
                            </div>
                            <div class="card-footer">
                                <h3 class="card-title"><a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a></h3>
                                <div class="card-meta"><span>${article.source}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // Event Listeners (unchanged)
            searchForm.addEventListener('submit', (e) => { e.preventDefault(); startNewSearch(searchInput.value); });
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const query = e.currentTarget.dataset.query;
                    searchInput.value = query;
                    startNewSearch(query);
                });
            });
            loadMoreBtn.addEventListener('click', () => { currentPage++; fetchNews(true); });
            startNewSearch(''); // Initial Load
        });
    </script>
</body>
</html>